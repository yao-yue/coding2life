## å¼€è¯¾å§  nodeéŸ³ä¹é¡¹ç›®
> 2018å¹´8æœˆçš„é¡¹ç›® ä½†æ˜¯ä¸å½±å“ï¼Œå…ˆæŠŠç²¾é«“å­¦äº†æ‰å¥½å­¦åˆ«çš„é¡¹ç›®

### é¡¹ç›®åŠŸèƒ½
1. ç™»å½•
2. æ³¨å†Œ
3. æ·»åŠ éŸ³ä¹
4. æ’­æ”¾éŸ³ä¹
5. ç¼–è¾‘éŸ³ä¹
6. åˆ é™¤éŸ³ä¹

### é¡¹ç›®ä¾èµ–
```
npm i  koa  koa-router koa-art-template art-template  koa-bodyparser  koa-static koa-session captchapng2  koa-formidable mysql -S
```
1. é¡¹ç›®æ¡†æ¶ koa
2. è·¯ç”±ç³»ç»Ÿ koa-router
3. é¡µé¢æ¸²æŸ“koa-art-template(ä¾èµ–art-template)
4. å¤„ç†æ–‡å­—è¯·æ±‚ä½“æ•°æ®  koa-bodyparser
5. å¤„ç†é™æ€æ–‡ä»¶ koa-static
6. å¤„ç†ç™»å½•åçš„session   koa-session
7. ç”ŸæˆéªŒè¯ç  captchapng2
8. å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„ è¯·æ±‚ä½“æ•°æ®  koa-formidable
9. è¿æ¥æ•°æ®åº“  mysql
   1. æŸ¥æ‰¾ç»“æœæ˜¯æ•°ç»„![52759876950](assets/1527598769506.png)


## æ¨¡æ¿æ‹†åˆ†å¼•ç”¨åŠç»§æ‰¿
ä¸­éƒ¨ç•™å‘
```
main.html
{{block 'content'}}
é»˜è®¤å†…å®¹
{{/block}}
    
{{extend './layout/main.html'}}
{{block 'content'}}
å­é¡µé¢å†…å®¹
{{/block}}
```


### MVC
Cï¼šæ¥æ”¶æ•°æ® ç”Ÿæˆè§†å›¾
è·¯ç”±ï¼š url --> åšä»€ä¹ˆäº‹ï¼ˆcontrolleræ¥å®‰æ’ï¼Œä¸šåŠ¡ç»ç†ï¼‰
controllerï¼š æ¥æ”¶æ•°æ® å“åº”é¡µé¢


### apiæµç¨‹
routeræ³¨å†Œ --> controlleré€»è¾‘  ---> modelså¼„æ•°æ®åº“ææ•°æ®


### å…³äºformidableå¤„ç†æ–‡ä»¶åŠå­—ç¬¦ä¸²
ç”¨bodyParserä¸å¤ªå¥½å¤„ç†æ–‡ä»¶
æ•°æ®åº“é‡Œé¢å­˜çš„æ˜¯è·¯å¾„ï¼Œè€Œä¸æ˜¯å­˜æ–‡ä»¶
é…ç½®
 // è®¾ç½®ä¸Šä¼ ç›®å½•ï¼Œå¦åˆ™åœ¨ç”¨æˆ·çš„tempç›®å½•ä¸‹
    uploadDir:uploadDir,
    // é»˜è®¤æ ¹æ®æ–‡ä»¶ç®—æ³•ç”Ÿæˆhashå­—ç¬¦ä¸²ï¼ˆæ–‡ä»¶åï¼‰ï¼Œæ— åç¼€
    keepExtensions:true


### é‡å®šå‘å’Œé‡å†™URL
é‡å®šå‘ï¼šå“åº”æµè§ˆå™¨ï¼Œè®©å…¶å†è¯·æ±‚
é‡å†™URLï¼šæœåŠ¡å™¨å†…éƒ¨çš„è°ƒç”¨(é¦–é¡µè·³è½¬),é™æ€èµ„æºä¹Ÿè¦é‡å†™ï¼Œè¿‡æ»¤æ‰public,è¦åœ¨è·¯ç”±å¤„ç†å‰

### ä¸­é—´ä»¶
ä¸­é—´ä»¶æ”¹å†™ä¼ å‚
module.exports = (options) => {
   return async () => {}
}

### æ•°æ®åº“ç›¸å…³
result.affectedRows !== 1    åˆ¤æ–­æ˜¯å¦æ“ä½œæˆåŠŸ

### åŠ å¯†
åç«¯åŠ å¯†æ˜¯ç‹é“ï¼Œæ³¨å†Œç™»å½•åŒç®—æ³•ï¼Œå‰ç«¯åŠ å¯†ä¸é è°±
npmæ‰¾ä¸ªåŒ…å°±å¯ä»¥çš„

### éªŒè¯ç  npmåŒ… captchapng2
è¿”å›ä¸€ä¸ªäºŒè¿›åˆ¶æµï¼Œimgæ ‡ç­¾èƒ½å¤„ç†

### ä¸€ä¸ªé—®é¢˜ï¼Ÿ ä¸ºä»€ä¹ˆè¦æœ‰é™æ€èµ„æºå¤„ç†ä¸­é—´ä»¶ï¼Œä»–æ˜¯å¹²ä»€ä¹ˆçš„

### å¤„ç†æ­Œè¯æ»šåŠ¨
1. ajaxè·å–æ­Œè¯æ•°æ®
2. è§£ææ­Œè¯ {"0":"å‘Šç™½æ°”çƒ", "4":"è¯ï¼šæ–¹æ–‡å±±"}
3. åˆ†ædomç»“æ„
4. å¼€å§‹æ»šåŠ¨ï¼Œæ»šåŠ¨éœ€è¦éšç€æ­Œæ›²çš„æ’­æ”¾å®é™…æ¥ï¼Œæ’­æ”¾çš„ç§’æ•°å’Œè¯ä¼šäº§ç”Ÿå…³è”
5. ç»™å½“å‰æ’­æ”¾çš„æ ‡ç­¾åŠ æ ·å¼
```
è§£ææ­Œè¯å‡½æ•°
1.ä»¥æ¢è¡Œç¬¦åˆ‡å‰²å­—ç¬¦ä¸²ï¼Œ
2.éå†è¯¥æ•°ç»„ï¼Œä»¥æ­£åˆ™æ¥åŒ¹é…æ•°æ®ï¼Œå…¶ä¸­è·å–åˆ°æ—¶é—´å’Œæ­Œè¯
      regex = /\[(\d{2})\:\d{2}\:\d{2}](.*)/ å°æ‹¬å·æ•è·
      exec() == res[]   res[0]æ˜¯åŸåŒ¹é…ï¼Œåé¢çš„å°±æ˜¯æ•è·çš„ 
3.è®¡ç®—æ—¶é—´ä½œä¸ºkey,å°†å…¶ä¸æ­Œè¯ä¸ºå¯¹è±¡æ·»åŠ å±æ€§
4.è¿”å›è¿™ä¸ªå¯¹è±¡
```
- è¡¥å……ï¼š å…³äºæ­Œè¯åŒ¹é…æ—¶é—´ç²¾ç¡®åº¦ï¼Œè¦çœ‹æ­Œè¯æ–‡ä»¶çš„å¯†åº¦
   å››èˆäº”å…¥ï¼Œ Math.round()


### æƒé™æ§åˆ¶
1. è¯·æ±‚urlæ˜¯å¦ä»¥/userå¼€å¤´ï¼Œæ˜¯åˆ™ç›´æ¥æ”¾è¡Œ
2. å¦åˆ™éªŒè¯sessioné‡Œé¢æ˜¯å¦æœ‰user,æ²¡æœ‰åˆ™è¯·æ±‚è·³è½¬åˆ°ç™»å½•é¡µé¢
> è¡¥å……ï¼Œå…³äºæŒä¹…ç™»å½•æ˜¯ç”¨localStroageæ¥åšçš„ä¹Ÿå°±æ˜¯å…³é—­é¡µé¢åä¸ç”¨å†é‡å†™ç™»å½•ï¼Œä¼šä¿å­˜ä½ çš„ä¿¡æ¯åˆ°æœ¬åœ°


### éƒ¨ç½²
- node.jsæ˜¯åŸºäºV8å¼•æ“è§£æå¹¶æ‰§è¡Œçš„æ‰€ä»¥ä¸åŒäºå…¶ä»–åç«¯è¯­è¨€ï¼Œéœ€è¦å…ˆç¼–è¯‘åæ‰èƒ½å†æœåŠ¡å™¨è¿è¡Œï¼ˆå³node.jsä¸éœ€è¦ç¼–è¯‘å°±èƒ½æ‰§è¡Œï¼‰
- node.jsè‡ªèº«åˆåŒ…å«æœåŠ¡å™¨ï¼ˆä¸ä¾èµ–apacheï¼Œtomcatä¹‹ç±»çš„ï¼‰ï¼Œæ‰€ä»¥å½“å¯åŠ¨äº†Nodejsçš„ç¨‹åºï¼Œå°±ä¼šåœ¨å½“å‰æœºå™¨çš„å…¬ç½‘IPå¹¶ç›‘å¬ç«¯å£è¿è¡ŒæœåŠ¡å™¨ã€‚å³åœ¨[ip:ç«¯å£]ä¸Šæä¾›æœåŠ¡

### PM2
ä¿éšœæœåŠ¡å™¨ä¸ä¼šæŒ‚æ‰ï¼ŒæŒ‚æ‰ä¼šè‡ªåŠ¨é‡å¯
1. å®‰è£… npm i -g pm2
2. pm2 start ./xxx.js --name projectname  //èµ·åˆ«å
> å…¶ä»–å‘½ä»¤
>  pm2 examples    //æŸ¥çœ‹å¸¸ç”¨æ“ä½œ
   pm2 [start | restart | stop | delete] all | name | id   //é‡å¯
   pm2 list        //æŸ¥çœ‹å¯åŠ¨çš„
   pm2 show name | id    æŸ¥çœ‹ä¿¡æ¯
   pm2 flush             æ¸…ç©ºæ—¥å¿—
   pm2 log nmae | id     æŸ¥çœ‹æ—¥å¿—


### nginx è¯·æ±‚åˆ†å‘
é…ç½®å…·ä½“localhostçš„è´Ÿè½½å‡è¡¡
```
# å£°æ˜ä»£ç†çš„æœåŠ¡å™¨
upstream mytest {
   ip_hash; #å…±äº«session é€šè¿‡IPæ¥è¾¨è¯†å…±æœ‰çš„cookieå’Œsessionçš„å€¼
   server localhost:8888 weight=1;  è¶Šå°æ¦‚ç‡è¶Šé«˜ 
   server localhost:9999 weight=1;
}
server {
   listen              80;
   server_name   localhost;
   location / {
      root    html;
      index   index.html;
      # å¦‚æœè®¿é—®/   ä»£ç†å»mytestç½‘ç«™ éœ€è¦åœ¨ä¸Šé¢å£°æ˜
      proxy_pass  http://mytest;    
   }
}
```

### art-templateä»£ç å‹ç¼©ã€æ··æ·†éœ€è¦é…ç½®ç”Ÿäº§æ¨¡å¼
NODE_ENV === 'production'

### sessionå…±äº«
upstream ä½¿ç”¨å†…ç½®ip_hashæ¥æ ‡è¯†session
   - ä¸ºæ¯ä¸ªIPåœ°å€æ¥åŒºåˆ†session
   - åŒIPåŒcookie

### å†™å‡ºæ¥çš„bugçœŸçš„æç¬‘ğŸ˜€
localhost  å†™æˆ loaclhost
from   å†™æˆ  form